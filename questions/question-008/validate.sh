#!/bin/bash

# Validation Script - Question 008
# Validates if the question was solved correctly

set +e  # Don't exit on error - we want to check all validations

echo "ğŸ” Validating solution for Question 008..."
echo ""

PASSED=0
FAILED=0

check() {
    local description="$1"
    local command="$2"
    
    echo -n "Checking: $description... "
    
    if eval "$command" &> /dev/null; then
        echo "âœ… PASSED"
        ((PASSED++))
        return 0
    else
        echo "âŒ FAILED"
        ((FAILED++))
        return 1
    fi
}

check_with_error() {
    local description="$1"
    local command="$2"
    local error_msg="$3"
    
    echo -n "Checking: $description... "
    
    if eval "$command" &> /dev/null; then
        echo "âœ… PASSED"
        ((PASSED++))
        return 0
    else
        echo "âŒ FAILED"
        echo "   ğŸ’¡ $error_msg"
        ((FAILED++))
        return 1
    fi
}

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Validation 1: Namespace exists"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
check "Namespace web exists" "kubectl get namespace web"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Validation 2: Pod exists"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
check "Pod cache exists in namespace web" "kubectl get pod cache -n web"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Validation 3: Pod is running"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

POD_STATUS=$(kubectl get pod cache -n web -o jsonpath='{.status.phase}' 2>/dev/null || echo "")

if [ "$POD_STATUS" = "Running" ]; then
    echo "âœ… PASSED: Pod cache is in Running state"
    ((PASSED++))
else
    echo "âŒ FAILED: Pod cache is not in Running state (current: $POD_STATUS)"
    echo "   ğŸ’¡ Make sure the pod is deployed and running"
    ((FAILED++))
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Validation 4: Image version"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

IMAGE=$(kubectl get pod cache -n web -o jsonpath='{.spec.containers[0].image}' 2>/dev/null || echo "")

if [ "$IMAGE" = "redis:3.2" ]; then
    echo "âœ… PASSED: Pod is using redis:3.2 image"
    ((PASSED++))
else
    echo "âŒ FAILED: Pod is not using redis:3.2 image (current: $IMAGE)"
    echo "   ğŸ’¡ Set image to redis:3.2"
    ((FAILED++))
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Validation 5: Port 6379 exposed"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

PORT=$(kubectl get pod cache -n web -o jsonpath='{.spec.containers[0].ports[0].containerPort}' 2>/dev/null || echo "")

if [ "$PORT" = "6379" ]; then
    echo "âœ… PASSED: Port 6379 is exposed"
    ((PASSED++))
else
    # Check if port is defined with name
    PORT_BY_NAME=$(kubectl get pod cache -n web -o jsonpath='{.spec.containers[0].ports[?(@.containerPort==6379)].containerPort}' 2>/dev/null || echo "")
    
    if [ "$PORT_BY_NAME" = "6379" ]; then
        echo "âœ… PASSED: Port 6379 is exposed"
        ((PASSED++))
    else
        echo "âŒ FAILED: Port 6379 is not exposed (current: $PORT)"
        echo "   ğŸ’¡ Add port 6379 to the container spec"
        ((FAILED++))
    fi
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Final Result"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… Tests passed: $PASSED"
echo "âŒ Tests failed: $FAILED"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "ğŸ‰ CONGRATULATIONS! All validations passed!"
    echo "âœ… The question was solved correctly."
    exit 0
else
    echo "âš ï¸  Some validations failed."
    echo "ğŸ“ Review the items above and try again."
    exit 1
fi

